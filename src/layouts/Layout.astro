---
import { ViewTransitions } from 'astro:transitions';
import Modal from '../components/Modal.astro';
import '../styles/global.css';

interface Props {
    title: string;
    description?: string;
}

const { title, description = 'VRChatで遊んでいる「そら」のサイトです。' } = Astro.props;
const siteName = "そら | soran.link";
const pageTitle = title === "そら | soran.link" ? siteName : `${title} | ${siteName}`;
const ogpImage = "https://soran.link/img/ogp.jpg";
const siteUrl = "https://soran.link";

const currentYear = new Date().getFullYear();
---

<!doctype html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☁️</text></svg>">
    <title>{pageTitle}</title>
    <meta name="description" content={description} />

    <!-- OGP Tags -->
    <meta property="og:title" content={pageTitle}>
    <meta property="og:description" content={description}>
    <meta property="og:image" content={ogpImage}>
    <meta property="og:url" content={Astro.url}>
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <ViewTransitions />
</head>
<body class="text-slate-700">
<div class="max-w-4xl mx-auto my-12 md:my-24 bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden">
    <main class="p-6 sm:p-10 md:p-16">
        <slot />
    </main>
    <footer class="bg-slate-100/70 text-slate-600">
        <div class="px-6 py-8 text-center text-sm">
            <div class="mb-4">
                <a href="/privacy" class="text-xs text-slate-500 hover:underline">プライバシーポリシー</a>
            </div>
            <p>&copy; {currentYear} soran.link. All Rights Reserved.</p>
        </div>
    </footer>
</div>

<Modal />

<style is:global>
    body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-image: url('/img/recent_photo_01.jpg');
        background-size: cover;
        background-position: center 70%;
        background-attachment: fixed;
    }
    .fade-in-section {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInSection 0.6s ease-out forwards;
    }
    @keyframes fadeInSection {
        from {
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
<script>
    document.addEventListener('astro:page-load', () => {
        // --- 1. 各セクションを監視する処理 ---
        const sections = document.querySelectorAll('.fade-in-section');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        sections.forEach(section => observer.observe(section));

        // --- 2. 写真拡大モーダルのための処理 ---
        const photoThumbnails = document.querySelectorAll('.photo-thumbnail');
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modal-img');
        const modalClose = document.getElementById('modal-close');

        const modalCaption = document.getElementById('modal-caption');
        const modalTitle = document.getElementById('modal-title');
        const modalDate = document.getElementById('modal-date');
        const modalWorld = document.getElementById('modal-world');

        if (!modal || !modalImg || photoThumbnails.length === 0) return;

        const openModal = (thumbnail) => {
            modalImg.src = thumbnail.src || thumbnail.dataset.src;

            if (modalCaption && modalTitle && modalDate && modalWorld) {
                const title = thumbnail.alt || '';
                const date = thumbnail.dataset.date || '';
                const worldName = thumbnail.dataset.worldName || '';
                const worldLink = thumbnail.dataset.worldLink || '';

                modalTitle.textContent = title;
                modalDate.textContent = date;

                modalWorld.innerHTML = '';
                if (worldName) {
                    if (worldLink) {
                        modalWorld.innerHTML = `<a href="${worldLink}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">World: ${worldName}</a>`;
                    } else {
                        modalWorld.textContent = `World: ${worldName}`;
                    }
                }
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        photoThumbnails.forEach((thumbnail) => {
            // Astroのページ遷移でリスナーが重複しないように、一度削除してから追加します
            const newThumbnail = thumbnail.cloneNode(true);
            thumbnail.parentNode.replaceChild(newThumbnail, thumbnail);
            newThumbnail.addEventListener('click', () => openModal(newThumbnail));
        });

        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });
        modalImg.addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal();
        });
        if(modalCaption) {
            modalCaption.addEventListener('click', (e) => {
                if (e.target.tagName !== 'A') {
                    e.stopPropagation();
                    closeModal();
                }
            });
        }
    });
</script>
<script type="text/javascript" src="//typesquare.com/3/tsst/script/ja/typesquare.js?5e27f6df91004ae4bf9f35d4ac1e0217" charset="utf-8"></script>
</body>
</html>
